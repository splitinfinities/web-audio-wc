<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="web-audio-source">
  <script>
    /**
     * `web-audio`
     * Provides a declarative way of working with the web audio API.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class WebAudioSource extends Polymer.Element {
      static get is () { return 'web-audio-source'; }
      static get properties () {
        return {
          src: {
            type: String,
            value: false
          },

          name: {
            type: String,
            value: false
          },

          midi: {
            type: Number,
            value: false
          },

          status: {
            type: String,
            value: "paused"
          },

          context: {
            type: Object,
            value: () => {
              return {};
            }
          },

          masterGain: {
            type: Object,
            value: () => {
              return {};
            }
          },

          buffer: {
            type: Object,
            value: () => {
              return {};
            }
          },

          source: {
            type: Object,
            value: () => {
              return {};
            }
          },

          pregain: {
            type: Object,
            value: () => {
              return {};
            }
          },

          gain: {
            type: Object,
            value: () => {
              return {};
            }
          },

          effects: {
            type: Object,
            value: () => {
              return {};
            }
          },

          entry: {
            type: Object,
            value: false
          }
        };
      }

      ready () {
        super.ready();
      }

      assignBuffer (context, masterGain, buffer) {
        this.context = context;
        this.masterGain = masterGain;
        this.buffer = buffer;

        this._prepareEffects();

        if (Object.keys(this.effects).length > 0) {
          // Make the source and gain
          this.pregain = this.context.createGain();
          let previous = false;

          Object.keys(this.effects).reverse().forEach((element, index) => {
            if (index === 0) {
              this.pregain.connect(this.effects[element]);
            } else {
              this.effects[previous].connect(this.effects[element]);
            }

            previous = element;
          });

          this.gain = this.context.createGain();
          this.effects[previous].connect(this.gain)
          this.gain.connect(this.masterGain);
        } else {
          this.gain = this.context.createGain();
          this.gain.connect(this.masterGain);
        }
      }

      play () {
        this.source = this.context.createBufferSource();

        this.source.buffer = this.buffer;

        if (Object.keys(this.effects).length > 0) {
          this.source.connect(this.pregain);
        } else {
          this.source.connect(this.gain);

        }

        this.source.start(0);
      }

      _prepareEffects () {
        if (this.parentNode.nodeName !== "WEB-AUDIO") {
          let element = this.parentNode;
          while (element.nodeName !== "WEB-AUDIO") {
            this.effects[element.getAttribute('name')] = element.attachEffect(this.context);

            element = element.parentNode;
          }
        }
      }
    }

    window.customElements.define(WebAudioSource.is, WebAudioSource);
  </script>
</dom-module>
