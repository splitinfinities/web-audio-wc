<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>web-audio demo</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

    <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
    <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
    <link rel="import" href="../web-audio.html">

    <custom-style>
      <style is="custom-style" include="demo-pages-shared-styles">
      </style>
    </custom-style>
  </head>
  <body>
    <div class="vertical-section-container centered">
      <h3>Basic web-audio demo</h3>
      <demo-snippet>
        <template>

          <web-audio-visualizer for="rave"></web-audio-visualizer>
          <web-audio-visualizer for="rave" type="webgl">
            <web-audio-visualizer-shader type="vertex">
              attribute vec2 position;

              void main(void) {
                gl_Position = vec4(position, 0, 1);
              }
            </web-audio-visualizer-shader>
            <web-audio-visualizer-shader type="fragment">
              precision mediump float;

              uniform float time;
              uniform vec2 resolution;
              uniform sampler2D spectrum;

              void main(void) {
                vec3 c;
                float z = 0.1 * time;
                vec2 uv = gl_FragCoord.xy / resolution;
                vec2 p = uv - 0.5;
                p.x *= resolution.x / resolution.y;
                float l = 0.2 * length(p);
                for (int i = 0; i < 3; i++) {
                  z += 0.07;
                  uv += p / l * (sin(z) + 1.0) * abs(sin(l * 9.0 - z * 2.0));
                  c[i] = 0.01 / length(abs(mod(uv, 1.0) - 0.5));
                }
                float intensity = texture2D(spectrum, vec2(l, 0.5)).x;
                gl_FragColor = vec4(c / l * intensity, time);
              }
            </web-audio-visualizer-shader>

          </web-audio-visualizer>

          <web-audio name="rave">
            <web-audio-source name="hum_base" src="http://localhost:3000/unbundled/node_modules/@splitinfinities/audio-stems/drums_relaxed.mp3"></web-audio-source>
          </web-audio>

          <web-audio-sequencer tempo="58.81" name="raver" taps="16"></web-audio-sequencer>

          <button onclick="webAudioSequencer.play();">play</button>

          <script>
            var rave = document.querySelector('web-audio[name="rave"]');
            var webAudioSequencer = document.querySelector('web-audio-sequencer[name="raver"]');

            sequencer = [];

            sequencer["raver"] = (iteration, time, beat, context) => {
              if (rave.ready) {
                // Start of the beat
                if (beat === 0) {
                  if ((iteration % 16) < 8) {
                    rave.source("hum_base").play();
                    rave.source("drums_relaxed").play();
                  } else {
                    rave.source("hum_base").play();
                    rave.source("hum_high").play();
                    rave.source("drums_excited").play();
                    rave.source("real_pizzicato").play();
                  }
                }
              }
            }

          </script>
        </template>
      </demo-snippet>
    </div>
  </body>
</html>
