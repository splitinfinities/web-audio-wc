<dom-module id="web-audio-sequencer">
  <script>
    /**
     * `web-audio`
     * Provides a declarative way of working with the web audio API.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class WebAudioSequencer extends Polymer.Element {
      static get is () { return 'web-audio-sequencer'; }
      static get properties () {
        return {
          context: {
            type: AudioContext,
            value: () => {
              return new AudioContext();
            }
          },

          name: {
            type: String,
            value: false
          },

          tempo: {
            type: Number,
            value: 58.81
          },

          noteTime: {
            type: Number,
            value: 0.0
          },

          startTime: {
            type: Number,
            value: 0.0
          },

          taps: {
            type: Number,
            value: 4
          },

          rhythmIndex: {
            type: Number,
            value: 0
          },

          iterations: {
            type: Number,
            value: 0
          },

          timeout: {
            type: Number,
            value: false
          },

          playing: {
            type: Boolean,
            value: false
          },
        };
      }

      ready () {
        super.ready();

        if (this.autoplay) {
          this.play();
        }
      }

      play () {
        this.iterations = 0;
        this.startTime = this.context.currentTime + 0.005;
        this._schedule();
      }

      stop () {
        this.iterations = 0;
        clearTimeout(this.timeout);
      }

      _custom (time) {
        if (window.sequencer[this.name]) {
          window.sequencer[this.name](this.iterations, this.noteTime, this.rhythmIndex, this.context);
        }
      }

      _schedule () {
        var currentTime = this.context.currentTime;

        // The sequence starts at startTime, so normalize currentTime so that it's 0 at the start of the sequence.
        currentTime -= this.startTime;

        while (this.noteTime < currentTime + 0.005) {
          var contextPlayTime = this.noteTime + this.startTime;

          if (this.rhythmIndex === 0) {
            this.iterations++;
          }

          this._custom(contextPlayTime);

          this._advance();
        }

        this.timeout = setTimeout(() => { this._schedule() }, 0);
      }

      _advance () {
        // Setting tempo to 60 BPM just for now
        var secondsPerBeat = 60 / this.tempo;

        this.rhythmIndex++;

        if (this.rhythmIndex == this.taps) {
            this.rhythmIndex = 0;
        }

        //0.25 because each square is a 16th note
        this.noteTime += 0.25 * secondsPerBeat;
      }
    }

    window.customElements.define(WebAudioSequencer.is, WebAudioSequencer);
  </script>
</dom-module>

